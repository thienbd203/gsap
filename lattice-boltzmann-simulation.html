<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>Lattice Boltzmann (D2Q9)</title>
<style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#1e3c72,#2a5298,#7e22ce);display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}.container{background:rgba(255,255,255,0.95);border-radius:20px;padding:30px;box-shadow:0 20px 60px rgba(0,0,0,0.5);max-width:1200px}h1{text-align:center;color:#1e3c72;margin-bottom:5px;font-size:2.2em}.subtitle{text-align:center;color:#666;margin-bottom:10px;font-size:0.9em}canvas{border:3px solid #1e3c72;border-radius:10px;display:block;margin:0 auto 20px;background:#000}.exp-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-bottom:15px}.exp-btn{background:linear-gradient(135deg,#16a085,#1abc9c);color:#fff;border:none;padding:10px;border-radius:8px;cursor:pointer;font-size:0.85em;font-weight:600;transition:all 0.2s}.exp-btn:hover{transform:translateY(-2px)}.exp-btn.active{background:linear-gradient(135deg,#e74c3c,#c0392b)}.controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:15px}.control-group{background:#f8f9fa;padding:15px;border-radius:10px}.control-group label{display:block;margin-bottom:8px;color:#495057;font-weight:600;font-size:0.85em}input[type="range"]{width:100%}.value-display{display:inline-block;background:#667eea;color:#fff;padding:3px 10px;border-radius:5px;font-size:0.85em;font-weight:bold}.button-group{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:15px}button{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-size:0.9em;font-weight:600;transition:all 0.2s}button:hover{transform:translateY(-2px)}.stats{display:flex;justify-content:space-around;margin-bottom:15px;flex-wrap:wrap;gap:10px}.stat-item{background:#f8f9fa;padding:10px 15px;border-radius:8px;text-align:center;flex:1;min-width:80px}.stat-label{font-size:0.7em;color:#666;display:block;margin-bottom:5px}.stat-value{font-size:1em;font-weight:bold;color:#667eea}.info{background:#e3f2fd;border-left:4px solid #2196f3;padding:12px;border-radius:5px;color:#0d47a1;font-size:0.85em;margin-bottom:15px}</style></head><body><div class="container"><h1>‚öõÔ∏è Lattice Boltzmann Method</h1><p class="subtitle">D2Q9 Model | BGK Collision | Statistical Mechanics</p><canvas id="c" width="800" height="320"></canvas><div class="info"><strong>D2Q9:</strong> 9 directions per cell. Streaming + Collision. Click canvas to move obstacle!</div><div class="exp-grid"><button class="exp-btn active" onclick="setExp('circle')">üî¥ Circle</button><button class="exp-btn" onclick="setExp('square')">‚¨õ Square</button><button class="exp-btn" onclick="setExp('double')">‚ö´‚ö´ Double</button><button class="exp-btn" onclick="setExp('airfoil')">‚úàÔ∏è Airfoil</button><button class="exp-btn" onclick="setExp('wedge')">üî∫ Wedge</button><button class="exp-btn" onclick="setExp('array')">‚ö™‚ö™‚ö™ Array</button></div><div class="controls"><div class="control-group"><label>üí® Velocity: <span class="value-display" id="vv">0.10</span></label><input type="range" id="vel" min="0.02" max="0.20" step="0.01" value="0.10" oninput="lbm.u0=+this.value;vv.textContent=this.value;updateRe()"></div><div class="control-group"><label>üåÄ Viscosity: <span class="value-display" id="nv">0.02</span></label><input type="range" id="vis" min="0.001" max="0.1" step="0.001" value="0.02" oninput="lbm.nu=+this.value;lbm.tau=3*lbm.nu+0.5;lbm.omega=1/lbm.tau;nv.textContent=this.value;updateRe()"></div><div class="control-group"><label>üé® Mode: <span class="value-display" id="mv">Curl</span></label><input type="range" id="mode" min="0" max="2" step="1" value="0" oninput="vizMode=+this.value;mv.textContent=['Curl','Speed','Pressure'][vizMode]"></div></div><div class="button-group"><button onclick="running=!running">‚èØÔ∏è Pause/Play</button><button onclick="lbm.init();lbm.setupObs()">üîÑ Reset</button><button onclick="location.href='fluid-experiments.html'">üè† Back</button></div><div class="stats"><div class="stat-item"><span class="stat-label">FPS</span><span class="stat-value" id="fps">0</span></div><div class="stat-item"><span class="stat-label">Re</span><span class="stat-value" id="re">500</span></div><div class="stat-item"><span class="stat-label">œÑ</span><span class="stat-value" id="tau">0.56</span></div><div class="stat-item"><span class="stat-label">Cells</span><span class="stat-value">16000</span></div></div></div><script>const c=document.getElementById('c'),ctx=c.getContext('2d'),W=800,H=320,NX=200,NY=80;ctx.imageSmoothingEnabled=false;const Q=9,ex=[0,1,0,-1,0,1,-1,-1,1],ey=[0,0,1,0,-1,1,1,-1,-1],wt=[4/9,1/9,1/9,1/9,1/9,1/36,1/36,1/36,1/36],opp=[0,3,4,1,2,7,8,5,6];let running=true,vizMode=0,expType='circle';class LBM{constructor(){this.nx=NX;this.ny=NY;this.size=NX*NY;this.f=Array(Q).fill(0).map(()=>new Float32Array(this.size));this.f_new=Array(Q).fill(0).map(()=>new Float32Array(this.size));this.rho=new Float32Array(this.size);this.ux=new Float32Array(this.size);this.uy=new Float32Array(this.size);this.obs=new Uint8Array(this.size);this.u0=0.10;this.nu=0.02;this.tau=3*this.nu+0.5;this.omega=1/this.tau;this.setupObs();this.init()}IX(x,y){return x+y*this.nx}eq(i,rho,ux,uy){const u2=ux*ux+uy*uy,eu=ex[i]*ux+ey[i]*uy;return wt[i]*rho*(1+3*eu+4.5*eu*eu-1.5*u2)}init(){for(let i=0;i<this.size;i++){this.rho[i]=1;this.ux[i]=this.u0;this.uy[i]=0;for(let j=0;j<Q;j++)this.f[j][i]=this.eq(j,1,this.u0,0)}}setupObs(){this.obs.fill(0);const cx=this.nx/3,cy=this.ny/2,r=this.ny/4;for(let y=0;y<this.ny;y++){for(let x=0;x<this.nx;x++){const dx=x-cx,dy=y-cy,d2=dx*dx+dy*dy;let isObs=false;if(expType==='circle')isObs=d2<r*r;else if(expType==='square')isObs=Math.abs(dx)<r&&Math.abs(dy)<r;else if(expType==='double'){const d1=dx*dx+(dy-r)*(dy-r),d2=dx*dx+(dy+r)*(dy+r);isObs=d1<(r*0.6)*(r*0.6)||d2<(r*0.6)*(r*0.6)}else if(expType==='airfoil'){const rx=(x-cx+r)/(2*r);if(rx>=0&&rx<=1){const t=0.12*(0.2969*Math.sqrt(rx)-0.126*rx-0.3516*rx*rx+0.2843*rx*rx*rx-0.1015*rx*rx*rx*rx);isObs=Math.abs(dy)<t*r*5}}else if(expType==='wedge'){const rx=x-cx+r;isObs=rx>0&&rx<2*r&&Math.abs(dy)<rx*r/(2*r)}else if(expType==='array'){for(let i=0;i<3;i++){const cxi=cx+(i-1)*this.ny/3,cyi=cy+((i%2)-0.5)*r;if((x-cxi)*(x-cxi)+(y-cyi)*(y-cyi)<(r/2)*(r/2))isObs=true}}if(isObs)this.obs[this.IX(x,y)]=1}}}collide(){for(let y=0;y<this.ny;y++){for(let x=0;x<this.nx;x++){const idx=this.IX(x,y);if(this.obs[idx])continue;let rho=0,ux=0,uy=0;for(let i=0;i<Q;i++){rho+=this.f[i][idx];ux+=ex[i]*this.f[i][idx];uy+=ey[i]*this.f[i][idx]}ux/=rho;uy/=rho;this.rho[idx]=rho;this.ux[idx]=ux;this.uy[idx]=uy;for(let i=0;i<Q;i++){const feq=this.eq(i,rho,ux,uy);this.f[i][idx]-=this.omega*(this.f[i][idx]-feq)}}}}stream(){for(let i=0;i<Q;i++)this.f_new[i].fill(0);for(let y=0;y<this.ny;y++){for(let x=0;x<this.nx;x++){const idx=this.IX(x,y);for(let i=0;i<Q;i++){const xn=x+ex[i],yn=y+ey[i];if(xn>=0&&xn<this.nx&&yn>=0&&yn<this.ny)this.f_new[i][this.IX(xn,yn)]=this.f[i][idx]}}}[this.f,this.f_new]=[this.f_new,this.f]}boundaries(){for(let y=0;y<this.ny;y++){const idx=this.IX(0,y);for(let i=0;i<Q;i++)this.f[i][idx]=this.eq(i,1,this.u0,0)}for(let x=0;x<this.nx;x++){const t=this.IX(x,0),b=this.IX(x,this.ny-1);for(let i=0;i<Q;i++){if(ey[i]<0)this.f[opp[i]][t]=this.f[i][t];if(ey[i]>0)this.f[opp[i]][b]=this.f[i][b]}}for(let idx=0;idx<this.size;idx++){if(this.obs[idx]){for(let i=0;i<Q;i++)[this.f[i][idx],this.f[opp[i]][idx]]=[this.f[opp[i]][idx],this.f[i][idx]]}}}step(){this.collide();this.stream();this.boundaries()}}const lbm=new LBM();function updateRe(){const L=NY/4,Re=Math.round(lbm.u0*L/lbm.nu);document.getElementById('re').textContent=Re;document.getElementById('tau').textContent=lbm.tau.toFixed(2)}function setExp(t){expType=t;lbm.setupObs();document.querySelectorAll('.exp-btn').forEach((b,i)=>b.classList.toggle('active',['circle','square','double','airfoil','wedge','array'][i]===t))}function render(){ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);const img=ctx.createImageData(W,H),data=img.data,curl=new Float32Array(lbm.size);let maxC=0;for(let y=1;y<NY-1;y++){for(let x=1;x<NX-1;x++){const idx=lbm.IX(x,y),c=(lbm.uy[lbm.IX(x+1,y)]-lbm.uy[lbm.IX(x-1,y)])-(lbm.ux[lbm.IX(x,y+1)]-lbm.ux[lbm.IX(x,y-1)]);curl[idx]=c;maxC=Math.max(maxC,Math.abs(c))}}const cw=W/NX,ch=H/NY;for(let y=0;y<NY;y++){for(let x=0;x<NX;x++){const idx=lbm.IX(x,y);let r=0,g=0,b=0;if(lbm.obs[idx]){r=g=b=60}else{if(vizMode===0){const c=curl[idx]/(maxC+0.001);if(c>0){r=Math.min(255,c*400);b=Math.min(200,c*300)}else{g=Math.min(255,-c*400);b=Math.min(200,-c*300)}}else if(vizMode===1){const s=Math.min(1,Math.sqrt(lbm.ux[idx]*lbm.ux[idx]+lbm.uy[idx]*lbm.uy[idx])/0.2);r=s*255;g=s*200;b=s*100}else{const p=(lbm.rho[idx]-1)*1000;r=Math.max(0,Math.min(255,p+128));g=Math.max(0,Math.min(200,128-Math.abs(p)));b=Math.max(0,Math.min(255,128-p))}}const px=Math.floor(x*cw),py=Math.floor(y*ch),pxe=Math.floor((x+1)*cw),pye=Math.floor((y+1)*ch);for(let py2=py;py2<pye;py2++){for(let px2=px;px2<pxe;px2++){if(px2<W&&py2<H){const i=(py2*W+px2)*4;data[i]=r;data[i+1]=g;data[i+2]=b;data[i+3]=255}}}}}ctx.putImageData(img,0,0)}let lastT=performance.now(),fc=0;function animate(){if(running)lbm.step();render();fc++;const t=performance.now();if(t-lastT>=1000){document.getElementById('fps').textContent=Math.round(fc*1000/(t-lastT));fc=0;lastT=t}requestAnimationFrame(animate)}c.onclick=e=>{const rect=c.getBoundingClientRect(),x=Math.floor((e.clientX-rect.left)/W*NX),y=Math.floor((e.clientY-rect.top)/H*NY),r=NY/4;for(let j=0;j<NY;j++){for(let i=0;i<NX;i++){const d=(i-x)*(i-x)+(j-y)*(j-y);lbm.obs[lbm.IX(i,j)]=d<r*r?1:0}}};updateRe();animate()</script></body></html>
